#!/bin/sh


#  Copyright (C)  2016-2017  Edgar Costa
#  See the file LICENSE for license details.


#VERSION
CONTROLLEDREDUCTION_MAJOR=0
CONTROLLEDREDUCTION_MINOR=1
CONTROLLEDREDUCTION_PATCH=0

SHARED=1
STATIC=0

PREFIX="/usr/local"
FLINT_DIR="" # "/usr/local"
GMP_DIR="" # "/usr/local"
MPFR_DIR="" # "/usr/local"
NTL_DIR="" # "/usr/local"


#set CC to gcc if CC is not set
if [  -z ${CC+word} ]; then
    CC="gcc"
fi;
#set CXX to g++ if CXX is not set
if [  -z ${CXX+word} ]; then
    CXX="g++"
fi;


LIBS="m"
ASSERT=1
GDB=1
OPENMP=1


# disable unnecessary libs and options
#unset PREFIX
#GMP_DIR=""
unset MPFR_DIR
#unset NTL_DIR
#CC=""
#CXX=""


usage()
{
    echo "Usage: ./configure <options> <args>"
    echo "   where <options> may be"
    echo "     -h or --help display usage information"
    echo "     --enable-assert or --disable-assert"
    echo "     --enable-gdb or --disable-gdb" 
    echo "     --enable-openmp or --disable-openmp" 
    echo "   where <args> may be:"

    if [ ! -z ${PREFIX+word} ]; then
        echo "     --prefix=<path>      Specify path to installation location (default: $PREFIX"
    fi

    if [ ! -z ${FLINT_DIR+word} ]; then
        echo "     --with-flint=<path>   Specify location of FLINT (default: $FLINT_DIR)"
    fi

    if [ ! -z ${GMP_DIR+word} ]; then
        echo "     --with-gmp=<path>    Specify location of GMP (default: $GMP_DIR)"
    fi

    if [ ! -z ${MPFR_DIR+word} ]; then
        echo "     --with-mpfr=<path>   Specify location of MPFR (default: $MPFR_DIR)"
    fi

    if [ ! -z ${NTL_DIR+word} ]; then
        echo "     --with-ntl=<path>    Specify location of NTL (default: $NTL_DIR)"
    fi;

    if [ -n "$CC" ]; then
        echo "     CC=<name>            Use the C compiler with the given name (default: $CC)"
        echo "     CFLAGS=<flags>       Pass the extra given flags to the compiler"
    fi

    if [ -n "$CXX" ]; then
        echo "     CXX=<name>           Use the C++ compiler with the given name (default: $CXX)"
        echo "     CXXFLAGS=<flags>     Pass the extra given flags to the C++ compiler"

    fi;
    
    
    }


absolute_path(){
   dirlist="$1"
   retval=""
   for dir in $dirlist; do
      case $dir in
        /*) dir=$dir;;
        *) dir=$PWD/$dir;;
      esac
      retval=$retval" "$dir
   done
   echo $retval
}

detect_dep(){
   var_name="$1"
   header="$2"
   libname="$3"
   shift 3
   for prefix in "$@"; do
      [ -z "$prefix" ] && continue
      if [ -f "$prefix/include/$header" ] || \
         [ -f "$prefix/include/x86_64-linux-gnu/$header" ] || \
         [ -f "$prefix/include/aarch64-linux-gnu/$header" ] || \
         [ -f "$prefix/include/arm-linux-gnueabihf/$header" ]; then
         for libdir in "$prefix/lib" "$prefix/lib64" \
             "$prefix/lib/x86_64-linux-gnu" \
             "$prefix/lib/aarch64-linux-gnu" \
             "$prefix/lib/arm-linux-gnueabihf"; do
            if [ -d "$libdir" ] && ls "$libdir/lib$libname."* >/dev/null 2>&1; then
               eval "$var_name=$prefix"
               return 0
            fi
         done
      fi
   done
   return 1
}

find_lib_dir(){
   prefix="$1"
   for libdir in "$prefix/lib" "$prefix/lib64" \
       "$prefix/lib/x86_64-linux-gnu" \
       "$prefix/lib/aarch64-linux-gnu" \
       "$prefix/lib/arm-linux-gnueabihf" \
       "$prefix/.libs" "$prefix/src/.libs"; do
      if [ -d "$libdir" ]; then
         echo "$libdir"
         return 0
      fi
   done
   return 1
}

find_inc_dir(){
   prefix="$1"
   header="$2"
   for incdir in "$prefix/include" \
       "$prefix/include/x86_64-linux-gnu" \
       "$prefix/include/aarch64-linux-gnu" \
       "$prefix/include/arm-linux-gnueabihf" \
       "$prefix/src" "$prefix"; do
      if [ -f "$incdir/$header" ]; then
         echo "$incdir"
         return 0
      fi
   done
   return 1
}

configure_dep(){
   dep="$1"
   dep_dir="$2"
   header="$3"
   if [ -z "$dep_dir" ]; then
      return 0
   fi
   dep_lib_dir=$(find_lib_dir "$dep_dir") || {
      echo "Invalid $dep directory"
      exit 1
   }
   dep_inc_dir=$(find_inc_dir "$dep_dir" "$header") || {
      echo "Invalid $dep directory"
      exit 1
   }
   eval "${dep}_LIB_DIR=\"$dep_lib_dir\""
   eval "${dep}_INC_DIR=\"$dep_inc_dir\""
   LIB_DIRS="${LIB_DIRS} ${dep_lib_dir}"
   INC_DIRS="${INC_DIRS} ${dep_inc_dir}"
}


while [ "$1" != "" ]; do
    PARAM=`echo $1 | sed 's/=.*//'`
    VALUE=`echo $1 | sed 's/[^=]*//; s/=//'`
    case "$PARAM" in
        -h|--help)
            usage
            exit 0
            ;;
        --with-flint)
            if [ ! -z ${FLINT_DIR+word} ]; then
                FLINT_DIR=$(absolute_path "$VALUE")
            fi
            ;;
        --with-gmp)
            if [ ! -z ${GMP_DIR+word} ]; then
                GMP_DIR=$(absolute_path "$VALUE")
            fi
            ;;
        --with-mpfr)
            if [ ! -z ${MPFR_DIR+word} ]; then
                MPFR_DIR=$(absolute_path "$VALUE")
            fi
            ;;
        --with-ntl)
            if [ ! -z ${NTL_DIR+word} ]; then
                NTL_DIR=$(absolute_path "$VALUE")
            fi
            ;;
        --prefix)
            if [ ! -z ${PREFIX+word} ]; then
                PREFIX=$VALUE
            fi
            ;;
        --enable-assert)
            ASSERT=1
            ;;
        --disable-assert)
            ASSERT=0
            ;;
        --enable-gdb)
            GDB=1
            ;;
        --disable-gdb)
            GDB=0
            ;;
        --enable-openmp)
            OPENMP=1
            ;;
        --disable-openmp)
            OPENMP=0
            ;;
        CC)
            CC="$VALUE"
            ;;
        CXX)
            CXX="$VALUE"
            ;;
        CFLAGS)
            CFLAGS="$VALUE"
            ;;
        CXXFLAGS)
            CXXFLAGS="$VALUE"
            ;;
        *)
            usage
            exit 1
            ;;
    esac
    shift
done

if [ -z "$SAGE_LOCAL" ] && [ -n "$SAGE_ROOT" ]; then
    SAGE_LOCAL="$SAGE_ROOT/local"
fi

if [ -z "$GMP_DIR" ]; then
    detect_dep GMP_DIR "gmp.h" "gmp" \
        "$SAGE_LOCAL" "$SAGE_ROOT/local" \
        "/opt/homebrew/opt/gmp" "/usr/local/opt/gmp" \
        "/opt/homebrew" "/usr/local" "/opt/local" "/usr"
fi

if [ -z "$FLINT_DIR" ]; then
    detect_dep FLINT_DIR "flint/flint.h" "flint" \
        "$SAGE_LOCAL" "$SAGE_ROOT/local" \
        "/opt/homebrew/opt/flint" "/usr/local/opt/flint" \
        "/opt/homebrew" "/usr/local" "/opt/local" "/usr"
fi

if [ -z "$NTL_DIR" ]; then
    detect_dep NTL_DIR "NTL/ZZ.h" "ntl" \
        "$SAGE_LOCAL" "$SAGE_ROOT/local" \
        "/opt/homebrew/opt/ntl" "/usr/local/opt/ntl" \
        "/opt/homebrew" "/usr/local" "/opt/local" "/usr"
fi

if [ -z "$MPFR_DIR" ]; then
    detect_dep MPFR_DIR "mpfr.h" "mpfr" \
        "$SAGE_LOCAL" "$SAGE_ROOT/local" \
        "/opt/homebrew/opt/mpfr" "/usr/local/opt/mpfr" \
        "/opt/homebrew" "/usr/local" "/opt/local" "/usr"
fi

if [ -z "$NTL_DIR" ]; then
    echo "NTL not found. Install NTL or rerun with --with-ntl=<path>."
    exit 1
fi
if [ -z "$FLINT_DIR" ]; then
    echo "FLINT not found. Install FLINT or rerun with --with-flint=<path>."
    exit 1
fi
if [ -z "$GMP_DIR" ]; then
    echo "GMP not found. Install GMP or rerun with --with-gmp=<path>."
    exit 1
fi
if [ -z "$MPFR_DIR" ]; then
    echo "MPFR not found. Install MPFR or rerun with --with-mpfr=<path>."
    exit 1
fi


configure_dep FLINT "$FLINT_DIR" "flint/flint.h"
if [ ! -z ${FLINT_DIR+word} ]; then
    LIBS="${LIBS} flint"
fi;


configure_dep GMP "$GMP_DIR" "gmp.h"
if [ ! -z ${GMP_DIR+word} ]; then
    LIBS="${LIBS} gmp gmpxx"
fi;


configure_dep MPFR "$MPFR_DIR" "mpfr.h"
LIBS="${LIBS} mpfr"


configure_dep NTL "$NTL_DIR" "NTL/ZZ.h"
if [ ! -z ${NTL_DIR+word} ]; then
    LIBS="${LIBS} ntl"
fi;

KERNEL=`uname`
ARCH=`uname -m`
OS=`uname -s`

# openmp on macOS (libomp)
if [ "$OPENMP" = "1" ] && [ $OS = "Darwin" ]; then
    if [ -z "$OMP_DIR" ]; then
        detect_dep OMP_DIR "omp.h" "omp" \
            "/opt/homebrew/opt/libomp" "/usr/local/opt/libomp" \
            "/opt/homebrew" "/usr/local" "/opt/local" "/usr"
    fi
    if [ -n "$OMP_DIR" ]; then
        if [ -d "${OMP_DIR}/lib" ]; then
            LIB_DIRS="${LIB_DIRS} ${OMP_DIR}/lib"
        elif [ -d "${OMP_DIR}/lib64" ]; then
            LIB_DIRS="${LIB_DIRS} ${OMP_DIR}/lib64"
        fi
        if [ -d "${OMP_DIR}/include" ]; then
            INC_DIRS="${INC_DIRS} ${OMP_DIR}/include"
        fi
    else
        OPENMP=0
    fi
fi

# include paths

INCS="-I'\$(CURDIR)'"
for INC_DIR in ${INC_DIRS}; do
   INCS="${INCS} -isystem${INC_DIR}"
done
if [ $OS = "Linux" ]; then
   if [ -d "/usr/include" ]; then
      INCS="${INCS} -isystem/usr/include"
   fi
   for SYS_INC in /usr/include/x86_64-linux-gnu \
       /usr/include/aarch64-linux-gnu \
       /usr/include/arm-linux-gnueabihf; do
      if [ -d "${SYS_INC}" ]; then
         INCS="${INCS} -isystem${SYS_INC}"
      fi
   done
fi

# library paths

LLIBS="-L'\$(CURDIR)'"
for LIB_DIR in ${LIB_DIRS} ${EXTRA_LIB_DIRS}; do
   LLIBS="${LLIBS} -L${LIB_DIR}"
done

lLIBS="";
# library params
for LIB in ${LIBS}; do
   lLIBS="-l${LIB} ${lLIBS}"
done
LIBS="$LLIBS $lLIBS"

if [ $OS = "Linux" ]; then
    LIBS="${LIBS} -lrt -lpthread"
fi

#defaults for CFLAGS
FLAGS="-pedantic -Wall -Wextra -O2 -funroll-loops"
if [ "$GDB" = "1" ]; then
    FLAGS="${FLAGS} -g";
fi

if [ "$OPENMP" = "1" ]; then
  if [ $OS = "Darwin" ]; then
    FLAGS="${FLAGS} -Xpreprocessor"
    LIBS="${LIBS} -lomp"
  fi
  FLAGS="${FLAGS} -fopenmp";
fi

if [ "$ASSERT" = "0" ]; then
    FLAGS="${FLAGS} -DNDEBUG";
fi

if [ -z "$CFLAGS" ]; then
    CFLAGS="${FLAGS} -std=c99"
fi
if [ -z "$CXXFLAGS" ]; then
    CXXFLAGS="${FLAGS} -std=c++11"
fi


#PIC flag

if [ -z "$PIC_FLAG" ]; then
   case "$OS" in
      CYGWIN* | MINGW*)
         ;;
      *)
         PIC_FLAG="-fPIC";;
   esac
fi

#name for the CONTROLLEDREDUCTION_LIB
CONTROLLEDREDUCTION_LIB_SOLIB=0
if [ -z "$CONTROLLEDREDUCTION_LIB" ]; then
   case "$OS" in
      Darwin)
         CONTROLLEDREDUCTION_LIBNAME="libcontrolledreduction.dylib"
	 CONTROLLEDREDUCTION_LIB="libcontrolledreduction-$CONTROLLEDREDUCTION_MAJOR.$CONTROLLEDREDUCTION_MINOR.$CONTROLLEDREDUCTION_PATCH.dylib"
         EXTRA_SHARED_FLAGS="-install_name $PREFIX/lib/$CONTROLLEDREDUCTION_LIB -compatibility_version $CONTROLLEDREDUCTION_MAJOR.$CONTROLLEDREDUCTION_MINOR -current_version $CONTROLLEDREDUCTION_MAJOR.$CONTROLLEDREDUCTION_MINOR.$CONTROLLEDREDUCTION_PATCH";;
      CYGWIN* | MINGW*)
         CONTROLLEDREDUCTION_LIBNAME="libcontrolledreduction.dll"
	 CONTROLLEDREDUCTION_LIB="libcontrolledreduction-$CONTROLLEDREDUCTION_MAJOR.dll"
	 EXTRA_SHARED_FLAGS="-static-libgcc -shared -Wl,--export-all-symbols -Wl,-soname,libcontrolledreduction-$CONTROLLEDREDUCTION_MAJOR.dll.$CONTROLLEDREDUCTION_MINOR.$CONTROLLEDREDUCTION_PATCH";;
      *)
         CONTROLLEDREDUCTION_LIBNAME="libcontrolledreduction.so"
	 CONTROLLEDREDUCTION_LIB="libcontrolledreduction.so.$CONTROLLEDREDUCTION_MAJOR.$CONTROLLEDREDUCTION_MINOR.$CONTROLLEDREDUCTION_PATCH"
	 EXTRA_SHARED_FLAGS="-Wl,-soname,libcontrolledreduction.so.$CONTROLLEDREDUCTION_MAJOR"
	 CONTROLLEDREDUCTION_SOLIB=1;;
   esac
fi

# sometimes LDCONFIG is not to be found in the path. Look at some common places.
case "$OS" in
    MINGW*|CYGWIN*|Darwin)
	LDCONFIG="true";;
    *)
	if [ -z "$LDCONFIG" ]; then
	    LDCONFIG="true"
	    if [ "$CONTROLLEDREDUCTION_SOLIB" = "1" ]; then
		if command -v ldconfig > /dev/null; then
		    LDCONFIG="ldconfig"
		elif [ -x /sbin/ldconfig ]; then
		    LDCONFIG="/sbin/ldconfig"
		fi
	    fi
	fi;;
esac

#extension for executables

if [ -z "$EXEEXT" ]; then
   case "$OS" in
      CYGWIN* | MINGW*)
         EXEEXT=".exe";;
      *)
         EXEEXT="";;
   esac
fi


if command -v python3 > /dev/null; then
    PYTHON=python3
elif command -v python > /dev/null; then
    PYTHON=python
else
    PYTHON=""
fi

if [ -n "$PYTHON" ]; then
    JOBS=`$PYTHON -c 'import multiprocessing as mp; print(mp.cpu_count() + 1)'`
elif command -v getconf > /dev/null; then
    JOBS=`getconf _NPROCESSORS_ONLN 2>/dev/null`
elif command -v sysctl > /dev/null; then
    JOBS=`sysctl -n hw.ncpu 2>/dev/null`
else
    JOBS=2
fi


echo "# This file is generated by ./configure -- do not edit!" > Makefile
echo "" >> Makefile
echo "SHELL=/bin/sh" >> Makefile
echo "" >> Makefile
echo "" >> Makefile
echo "CONTROLLEDREDUCTION_STATIC=$STATIC" >> Makefile
echo "CONTROLLEDREDUCTION_SHARED=$SHARED" >> Makefile
echo "CONTROLLEDREDUCTION_LIB=$CONTROLLEDREDUCTION_LIB" >> Makefile
echo "CONTROLLEDREDUCTION_LIBNAME=$CONTROLLEDREDUCTION_LIBNAME" >> Makefile
echo "CONTROLLEDREDUCTION_MAJOR=$CONTROLLEDREDUCTION_MAJOR" >> Makefile
echo "CONTROLLEDREDUCTION_SOLIB=$CONTROLLEDREDUCTION_SOLIB" >> Makefile
echo "PREFIX=$PREFIX" >> Makefile
echo "OS=$OS" >> Makefile
echo "" >> Makefile
echo "" >> Makefile
echo "INCS=$INCS" >> Makefile
echo "LIBS=$LIBS" >> Makefile
echo "" >> Makefile
echo "CC=$CC" >> Makefile
echo "CXX=$CXX" >> Makefile
echo "AR=$AR" >> Makefile
echo "LDCONFIG=$LDCONFIG" >> Makefile
echo "" >> Makefile
echo "" >> Makefile
echo "CFLAGS=$CFLAGS" >> Makefile
echo "CXXFLAGS=$CXXFLAGS" >> Makefile
echo "PIC_FLAG=$PIC_FLAG" >> Makefile  
echo "" >> Makefile
echo "" >> Makefile
echo "JOBS=$JOBS" >> Makefile
echo "" >> Makefile
echo "" >> Makefile
echo "EXEEXT=$EXEEXT" >> Makefile
echo "" >> Makefile
echo "" >> Makefile


cat Makefile.in >> Makefile

echo "CONTROLLED-REDUCTION was successfully configured."
